---
title: "A Deeper Dive Into COVID-Related Relationships"
author: "Tracy Huang, Helen Feibes, Henry Bassett"
date: "12/15/21"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: "kate"
---

```{r setup, include = FALSE}
library(tidyverse)
library(kableExtra) # for example code; delete if not needed

# Set code chunk defaults 
knitr::opts_chunk$set(echo = FALSE, 
                      mesage = FALSE,
                      warning = FALSE,
                      fig.align = "center")

# Set R environment options
options(knitr.kable.NA = '')
```

# Introduction
Why should anyone care about this? 
What is this about? Do not assume your readers have any specific knowledge of your subject matter! 

# Data Sources
What are the data? What was the source of the data (who collected it, when, in what way, and why)? What kind of data was it? Is there a link to the data or some other way for the reader to follow up on your work? 

# Census Bureau Pulse Survey Data

## Introduction

Young adults, particularly college students, have experienced many difficult and unique struggles during the pandemic. In 2021 alone, uncertainties about living situations, remote or in-person classes, vaccination availability, the Delta variant, and more have impacted the mental and physical health of these individuals. Building off our previous Shiny app project, we were interested in investigating the relationships between mental health, healthcare access, and race and ethnicity during COVID-19. To do so, we investigated whether or not an unsupervised clustering algorithm could identify racial/ethnic groups from healthcare-related variables. Further we arranged racial/ethnic groups in a network where connections between groups are weighted by how similar their population samples responded to questions about mental health symptoms, access to mental health resources, and healthcare coverage.

## Data Sources 

We created our clustering and racial/ethnic groups network with data from the U.S. Census Bureau's Household Pulse Survey. This ongoing survey is designed to collect information on how COVID-19 has impacted the social and economic lives of American households; it is motivated by the idea that understanding the pandemic's impacts will aid in building policy and outreach programs to help individuals and families recover from the pandemic.

The specific data-sets we used were those from weeks 22 through 39, which cover 6 January 2021 to 11 October 2021. This time frame encapsulates the introduction of the COVID-19 vaccines as well as the introduction of the Delta Variant into the U.S. We focused on college-aged individuals (18-25) and pulled out the following survey questions:

* "What is your race?" and "Are you of Hispanic, Latino, or Spanish origin?", from which individuals can be classified into 5 different racial/ethnic groups: 
  + Hispanic or Latino
  + Non-Hispanic White
  + Non-Hispanic Black
  + Non-Hispanic Asian
  + Non-Hispanic Other/Multiple Races

* "Over the last 2 weeks, how often have you been bothered by feeling nervous, anxious, or on edge?" and, similarly, "Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless?", for which an individual can respond 
  + Not at all
  + Several days
  + More than half the days
  + Nearly every day

* "At any time in the last 4 weeks, 
  + "did you take prescription medication to help you with any emotions or with your concentration, behavior or mental health?"
  + "did you receive counseling or therapy from a mental health professional such as a psychiatrist, psychologist, psychiatric nurse, or clinical social worker?"
  + "did you need counseling or therapy from a mental health professional, but DID NOT GET IT for any reason?"
  
  For each of these three questions, an individual can respond "Yes" or "No"

* "Are you currently covered by any of the following types of health insurance or health coverage plans?" which includes many types of healthcare. Any respondent who answered "Yes" to one of the healthcare types is labeled as having some healthcare coverage, whereas individuals who responded "No" to all healthcare types is labeled as having no healthcare coverage.

MENTION HOW WE PULLED ONLY CHRONIC DEPRESSION/ANXIETY OR DIDNT DO THAT IDK. OR JUST DO THIS IN THE CODE CHUNK COMMENTS. 

Visit [the Census Bureau website](https://www.census.gov/programs-surveys/household-pulse-survey.html) to explore and download the data-sets. 

## Data Wrangling: Clustering

After filtering for our population and time frame of interest and combining individuals' answers to the above questions, we further wrangled the data for clustering and the network. 

For clustering, we were particularly interested in the disparities in access to or use of mental health and healthcare resources between racial/ethnic groups, which may be particularly exacerbated during COVID-19. To group similar individuals in this regard, we used kmeans clustering and the `mclust` package. Kmeans clustering requires variables to cluster by (the data the algorithm uses to identify implicit patterns), a chosen number of clusters to identify (`centers = `), and a number of initial random cluster centers to try out (`nstart = `). As we suggested that there may be distinct clusters based on racial/ethnic groups, we set the algorithm to identify five clusters. We clustered based on individuals' responses to questions of taking prescription medication, using mental health counseling or similar services, needing access to mental health care but not receiving it, and having healthcare coverage.

```{r kmeans, echo=TRUE, eval=FALSE}
# Set seed for reproducibility 
set.seed(1984)
# Cluster with healthcare access variables
clustering_vars <- c("prescription", "mental_health_services", "no_access", "healthcare")
# From data set with all variables (columns) and all respondents (rows), select only those for clustering
pulse_all_clusters <- pulse_college_data %>% 
  select(clustering_vars) %>% 
  # Try 5 clusters (there are 5 racial/ethnic groups) and 25 initial centers
  kmeans(centers = 5, nstart = 25)

# Add cluster assignments to data frame
pulse_clustered_data <- pulse_college_data %>% 
  mutate(clusters = factor(pulse_all_clusters$cluster))
```

We then constructed an elbow plot to assess whether or not five was an optimal number of clusters to use. The "elbow" bends where the total within-cluster sum of squares (which measures variation within clusters) begins decreasing linearly. At this point, identifying more clusters becomes less useful. Viewing this plot, it is clear either five or six clusters is optimal. 

```{r echo=TRUE, eval=FALSE}
# Check usefulness of 5 clusters with elbow plot
elbow_plot <- data.frame(clusters = 1:10,
                         within_ss = rep(NA, 10))

set.seed(1984)
for (i in 1:10){
  pulse_out <- pulse_clustered_data %>% 
    select(clustering_vars) %>% 
    kmeans(centers = i, nstart = 25)
  
  elbow_plot$within_ss[i] <- pulse_out$tot.withinss
}

# Construct elbow plot
clusters_elbow <- ggplot(elbow_plot, aes(x = clusters, y = within_ss)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = 1:10) +
  labs(x = "Number of clusters (k)", y = expression("Total Withins"[k]))
```

```{r}
knitr::include_graphics("images_and_plots/clusters_elbow.png")
```


We can visualize clusters with three-dimensional scatter plots. Since we clustered on four variables, we can use an interactive `plotly` scatter plot to switch between variables and explore the clusters.

## Creating the interactive plotly in Shiny app {.tabset .tabset-fade .tabset-pills}


### Setting up choices

```{r echo=TRUE, eval=FALSE}
# Set up choices for input variables
# Choose 3 of the 4 vairables used to do the Kmeans Clustering
choice_values <- c("prescription", "mental_health_services", "no_access", "healthcare")
# Names for reactive axes
choice_axes <- c("Prescription", "Counseling or similar", "Needed but did not get", "Some healthcare")
names(choice_values) <- choice_axes
# Overwrite previous names to use for the drop-down
choice_names <- c("Prescription medication", "Mental health counseling or similar service", "Could not access mental health care when needed", "Some form of healthcare")
names(choice_values) <- choice_names
```

### UI

```{r echo=TRUE, eval=FALSE}
ui <- fluidPage(title = "Clusters Plot",
                fillPage(sidebarLayout(
                  sidebarPanel(
                    selectInput(
                      inputId = "var1",
                      label = "Select the first variable to plot",
                      choices = choice_values,
                      selected = "prescription",
                      multiple = FALSE
                    ),
                    selectInput(
                      inputId = "var2",
                      label = "Select the second variable to plot",
                      choices = choice_values,
                      selected = "mental_health_services",
                      multiple = FALSE
                    ),
                    selectInput(
                      inputId = "var3",
                      label = "Select the third variable to plot",
                      choices = choice_values,
                      selected = "no_access",
                      multiple = FALSE
                    ),
                    # Add submit button so user changes don't take effect until they are done selecting all three variables
                    submitButton(text = "Make plot", icon = NULL, width = NULL),
                    # Add note about jitter
                    h5("The values on this plot are jittered to visualize the density of each cluster. Values near 2 indicate an individual responded `no` to the survey question, while values near 1 indicate a response of `yes`."),
                  ),
                  mainPanel(plotlyOutput("clusters")
                  )
                )))
```

###  Server

```{r echo=TRUE, eval=FALSE}
server <- function(input, output){

  output$clusters <- renderPlotly({
    # Create plotly 3D scatter, jitter points for clarity, color by cluster
    plot_ly(pulse_clustered_data, 
            x = ~jitter(get(input$var1)), 
            y = ~jitter(get(input$var2)), 
            z = ~jitter(get(input$var3)), 
            type="scatter3d", mode="markers", color = ~clusters) %>% 
      layout(title = list(text = "Mental Health and Healthcare Resources Kmeans Clustering"),
             scene = list(xaxis = list(title = paste(choice_axes[choice_values == input$var1])), 
                          yaxis = list(title = paste(choice_axes[choice_values == input$var2])),
                          zaxis = list(title = paste(choice_axes[choice_values == input$var3]))),
             legend = list(title=list(text='<b> Cluster </b>'))
             )
  })
  
}
```

## Clusters Patterns

To investigate what patterns the clusters identified, we then looked at the breakdown of racial/ethnic groups and responses to the four mental health and healthcare variables within each cluster. For the latter, we created an animated stacked bar chart which cycles through the proportions of individuals answering "yes" and answering "no" in each cluster to the four survey questions we clustered on. This was achieved with the `gganimate` package; the function `transition_states()` allows us to plot the previously defined `ggplot` object while cycling through the "type" column in our data frame, which contains information on which of the four healthcare variables a given data point comes from.

```{r gganimate, echo=TRUE, eval=FALSE}
animate_hc <- ggplot() +
  # First layer always fills entire length of the bar chart (0-1)
  # Since all proportions add to 1 in total, this layer represents "no" responses once overlaid by the second layer
  geom_col(data = clusters_bottom_layer,
           mapping = aes(x = clusters,
                         y = total, 
                         fill = "No")) +
  # Filtering for `value == 1` gives "yes" answers
  geom_col(data = clusters_characteristics %>% filter(value == 1),
           mapping = aes(x = clusters,
                         y = prop_type,
                         fill = "Yes")) +
  # Create legend
  scale_fill_manual(name = "Respondent's answer",
                    labels = c("Yes", "No"),
                      values = c("Yes" = "thistle", "No" = "palegreen3")) +
  # Transition between the four variables with `type`, spend more time on each state than during transition
  transition_states(type, transition_length = 1, state_length = 6) +
  # Have new points drift in and travel the full distance they represent
  enter_drift(x_mod = 0, y_mod = clusters_characteristics$prop_type) +
  # Have old points shrink out of the animation
  exit_shrink() +
  # Flip horizontally
  coord_flip() +
  # Get title to change as states change
  labs(title = "{closest_state}",
       x = "Cluster",
       y = "Proportion of respondents")
```

```{r}
knitr::include_graphics(c("images_and_plots/clusters_breakdown_r_e.png", "images_and_plots/clusters_breakdown.gif"))
```

## Findings: Clustering

While the kmeans clustering did not elegantly separate out the five racial/ethnic groups, it did demonstrate that access to mental health and healthcare resources is not independent of race and ethnicity. That is the distribution of racial/ethnic groups across clusters and compared to the distribution for all Pulse Survey respondents differs. Most strikingly, cluster 5 has prominently more Hispanic or Latino and Black individuals in it, and fewer white individuals, than the distribution of all respondents. Importantly, cluster 5 is also the cluster where nearly all individuals do not use prescription medication, do not participate in counseling or something similar, and do not have healthcare coverage. However, maybe surprisingly, individuals in this cluster indicated that they've largely been able to access mental health care resources when they needed them. 

Further, the clusters which are more predominantly white than the full respondents pool - clusters 1 and 2 - are also those where the most access to care and resources lie, with the main difference being that individuals in cluster 2 do not utilize counseling or similar mental health services, whereas individuals in cluster 1 do. 

## Limitations: Clustering

Overall, while clustering is a fun exercise to see what patterns emerge, this was quite limited by the clustering variables, which, though represented numerically, are actually categorical variables. Quantitative and more nuanced variables would provide more meaningful and complex information to identify similar groups with. 

## Data Wrangling: Network

For the network, we wanted to connect racial/ethnic groups by the experiences of anxiety and depression, and the access to mental health and healthcare resources of their individuals. To do so, we compared the proportions of individuals in each group who 

* experienced chronic (more than half the days or nearly every day) anxiety 
* experienced chronic depression
* took prescription medication
* participated in counseling or something similar
* needed access to but did not receive mental health care
* had some form of healthcare

For each pair of racial/ethnic groups, we calculated the difference in these proportions. Thus, smaller differences provided more weight to the network edges, indicating more similar "experiences" (that is, proportions) between those groups.

The following code wrangles the anxiety variable, but the same procedure was repeated for the other five variables. For an explanation of the `igraph` and `visNetwork` packages, see the Data Wrangling Tab for COVID-19 Restrictions (CAN WE LINK BACK TO THIS). 

```{r echo=TRUE, eval=FALSE}
# From larger data set with all mental health variables, select anxiety
anx_visNetwork <- r_e_network %>% 
  select(race_ethnicity_one, race_ethnicity_two, anx) %>% 
  # Create igraph object
  graph_from_data_frame(directed = FALSE) %>% 
  # Create visNetwork object
  toVisNetworkData()
```

We then got the nodes and edges for the network. For the edges, a new column, `value`, was created, which is where the network will pull the weight or size of the edges from. 

```{r echo=TRUE, eval=FALSE}
# Get nodes and weighted edges
anx_nodes <- anx_visNetwork$nodes 
anx_edges <- anx_visNetwork$edges %>% 
  mutate(value = anx) 
```

## Creating the interactive network using `visNetwork` in Shiny app {.tabset .tabset-fade .tabset-pills}

### UI

```{r echo=TRUE, eval=FALSE}
ui <- fluidPage(
  theme = shinytheme("lumen"),
  title = "Racial/Ethnic Groups Network",
  
                fillPage(sidebarLayout(
                  sidebarPanel(
                    selectInput(
                      inputId = "hc_variable",
                      label = "Select a type of health care variable",
                      choices =  list(
                        "Anxiety" = "anx",
                        "Depression" = "dep",
                        "Prescription Medication" = "presc",
                        "Counseling or similar services" = "mhs",
                        "Needed but did not receive care" = "no_a",
                        "Healthcare coverage" = "hc"),
                      selected = "anx",
                      multiple = FALSE
                    ),
                  ),
                  mainPanel(
                    visNetworkOutput("network_proxy_update_re", width = "100%", height = "90vh")
                  )
                )))
```

###  Server

```{r echo=TRUE, eval=FALSE}
server <- function(input, output) {
  active_nodes <- reactive({
    switch(input$hc_variable,
           "anx" = anx_nodes,
           "dep" = dep_nodes,
           "presc" = presc_nodes,
           "mhs" = mhs_nodes,
           "no_a" = no_a_nodes,
           "hc" = hc_nodes)
  })
  
  active_edges <- reactive({
    switch(input$hc_variable,
           "anx" = anx_edges,
           "dep" = dep_edges,
           "presc" = presc_edges,
           "mhs" = mhs_edges,
           "no_a" = no_a_edges,
           "hc" = hc_edges
    )
  })
  output$network_proxy_update_re <- renderVisNetwork({
    visNetwork(active_nodes(), active_edges(), height = "700px", width = "100%",
               scaling = list(min = min(input$hc_variable), max = max(input$hc_variable)),
               main = list(text = "Network for Mental Health Symptoms and Access to Resources for Racial/Ethnic Groups", 
                           style = "font-family:Arial;font-size:20px"
               ),
               submain = list(text = 
                                "*Edges are weighted by how similar groups are in terms of the proportion of people<br>
                                  experiencing mental health symptoms or having access to mental health resources",
                              style = "font-family:Arial;font-size:13px")) %>%
      visNodes(size = 10) %>%
      visOptions(highlightNearest = list(enabled = TRUE, hover = TRUE), 
                 nodesIdSelection = TRUE) %>%
      visPhysics(stabilization = FALSE) %>%
      visEdges(color = list(color = "black", highlight = "red")) 
  })
  
  myreVisNetworkProxy <- visNetworkProxy("network_proxy_update_re")

}

#####################
# call to shiny App #
#####################
shinyApp(ui = ui, server = server)
```

## Findings: Network

This network allows users to explore the relationships between different racial/ethnic groups and how individuals within different racial/ethnic groups have experienced their mental health during the pandemic. 

One interesting pattern is that similar proportions of Non-Hispanic white and Non-Hispanic other or multiracial individuals experienced anxiety, as well as used mental health services, were covered by healthcare, and could not access care when needed. In each case, the proportions of these two groups were the highest out of all the groups. On the other end, the Non-Hispanic Asian group showed the lowest frequency of individuals experiencing anxiety and depression symptoms, as well as accessing medication and counseling services, and being unable to access resources when needed. Thus, the weakest connections between racial/ethnic groups often occurred between the Non-Hispanic Asian group and the others. When it comes to individuals with some form of healthcare, Non-Hispanic Black and Hispanic or Latino individuals share similar proportions and the lowest proportions out of the five groups. 



## Limitations: Network

What are the limitations of your work? Be clear so that others do not misinterpret your findings. To what population do your results apply? Do they generalize? Could your work be extended with more data or computational power or time to analyze? How could your study be improved? Suggesting plausible extensions doesn’t weaken your work; it strengthens it by connecting it to future work. 

One big limitation is that this analysis is restricted to during the pandemic. As COVID-19 has opened up many conversations about mental and physical health and access to care, it would be interesting to expand this analysis to before COVID-19. Is it possible that more individuals have access now to forms of mental health care because of the conversations prompted be the pandemic?

It is also important to note that the Household Pulse Survey relies on online responses from individuals who opt in, creating response bias and likely leaving out individuals in rural areas. 

While the survey questions are meaningful, categorical variables necessarilly lack nuance. More quantitative questions could provide more powerful information. For example, we might be interested in the number of visits to a healthcare or mental health care provider in a week, the cost of these visits or of prescription medication, or even days taken off from work due to physical or mental health complications. This information may reflect more any patterns of racial/ethnic privilege and disparities, and would open the option for statistical analysis through fitting a predictive model of some sort. 




For example, you can include **Bold** and _Italic_ and `Code` text.  

You should test out updating your GitHub Pages website:

* clone your group's blog project repo in RStudio
* update "Your Project Title Here" to a new title in the YAML header
* knit `index.Rmd` (we will now knit to HTML by default instead of pdf)
* commit and push **both** `index.Rmd` and `index.html`
* go to https://stat231-f21.github.io/blog_THeHe/ to see the published test document (this is publicly available!)

## Including code and plots

You can embed code as normal, for example:

```{r cars}
summary(cars)
```

Let's clean up the format of that output instead of using the standard R output:

```{r pretty-table, echo = TRUE}
summary(cars) %>%
  kable(col.names = c("Speed", "Distance"),
        row.names = FALSE) %>%
  kable_styling(bootstrap_options = "striped",
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1:2, width = "1.5in") 
```

In a study from the 1920s, fifty cars were used to see how the speed of the car and the distance taken to stop were related.  Speeds ranged between `r min(cars$speed)` and `r max(cars$speed)` mph.  Distances taken to stop ranged between `r min(cars$dist)` and `r max(cars$dist)` feet, with the middle 50% falling between `r as.numeric(quantile(cars$dist)[2])` and `r as.numeric(quantile(cars$dist)[4])` feet.  

You can also embed plots as normal, for example:

```{r figure1}
ggplot(data = cars, aes(x = speed, y = dist)) + 
  geom_point() + 
  labs(x = "Speed of car (mph)",
       y = "Distance taken to stop (ft)",
       title = "Stopping distance increases with faster speeds",
       subtitle = "Based on 1920s study") +
  theme_classic()
```

Take note of the default code chunk options in the `setup` code chunk, and adjust individual code chunk options as needed. for example, unlike the rest of the Rmd files we worked in this semester, the default code chunk option is `echo = FALSE`, so you will need to set `echo  = TRUE` for any code chunks you would like to display in the blog. 


## Including links and images/videos

You can include [links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and there are a few ways to embed  images! Both options for embedding images below can be used interchangeably. They both work for png, pdf, jpg, and even gif formats, and both support filepaths that are either URLs (for videos, you can include links to any valid YouTube or Vimeo URLs; see [here](https://bookdown.org/yihui/rmarkdown/learnr-videos.html) for more details) or point to a location within your project directory. 

### Option 1: Markdown approach

<!-- ![This is a figure caption. The artwork is called Safe Space by  [Kenesha Sneed](https://www.keneshasneed.com/#/safespace/)](img/Kenesha-Sneed_safe-space.jpeg) -->


### Option 2: Code chunk approach

```{r, fig.cap = "This is also figure caption"}
knitr::include_graphics("https://media.giphy.com/media/H7ZrrA9V2pd3Tehdds/giphy.gif")
```

# You can even create tabs within your webpage if you want! {.tabset .tabset-fade .tabset-pills}

Every subsection heading (starting with `##`) until you create a new section heading (starting with `#`) will be a new tab.

## Bulleted list

You can make a bulleted list like this:

* item 1
* item 2
* item 3


## Numbered list

You can make a numbered list like this

1. First thing I want to say
2. Second thing I want to say
3. Third thing I want to say

# Customizing your blog design

As a *final* detail **only** if you have time, you can explore options for customizing the style of your blog. By default, we are using the `readthedown` theme from the [**rmdformats** package](https://github.com/juba/rmdformats) (see Line 6 of this file if you want to switch out themes). There are, I'm sure, many many many more similar packages with built in themes, or you can look into how to include a CSS code chunk to customize aspects of the current theme.  

There are some easy-to-change options that you can play around with:

* The theme itself (Line 6): `rmdformats::readthedown`, `rmdformats::downcute`, `rmdformats::robobook`, `rmdformats::material`,
  * For `downcute` only, you can add a new indented line below Line 6 with the code `downcute_theme: "chaos"` for the `downcute chaos` theme
  * I would *not* recommend the other themes that do not have the sidebar navigation
  
* Syntax highlighting options (Line 8, `highlight`): `"default"`, `"tango"`, `"pygments"`, `"kate"`, `"monochrome"`, `"espresso"`, `"zenburn"`, `"haddock"`, or `"textmate"` (or `NULL` for no syntax highlighting)


You can explore additional customizable YAML options by looking at the [**rmdformats** package](https://github.com/juba/rmdformats) page or running, for example, `?rmdformats::readthedown()` to see the help documentation for a particular theme from the package.
