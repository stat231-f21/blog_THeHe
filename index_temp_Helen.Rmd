---
title: "A Deeper Dive Into COVID-Related Relationships"
author: "Tracy Huang, Helen Feibes, Henry Bassett"
date: "12/15/21"
output:
  rmdformats::readthedown:
    thumbnails: false
    highlight: "kate"
---

```{r setup, include = FALSE}
library(tidyverse)
library(kableExtra) # for example code; delete if not needed

# Set code chunk defaults 
knitr::opts_chunk$set(echo = FALSE, 
                      mesage = FALSE,
                      warning = FALSE,
                      fig.align = "center")

# Set R environment options
options(knitr.kable.NA = '')
```

# Introduction
Why should anyone care about this? 
What is this about? Do not assume your readers have any specific knowledge of your subject matter! 

# Data Sources
What are the data? What was the source of the data (who collected it, when, in what way, and why)? What kind of data was it? Is there a link to the data or some other way for the reader to follow up on your work? 

# Census Bureau Pulse Survey Data

WE SHOULD SAY SOMETHING ABOUT WHY WE USED THE SAME TIME FRAME AS BEFORE
AS WELL AS WHY WE IGNORED THE PHASE DIFFERENCES THIS TIME...
AS WELL AS REITERATE WHAT OUR POP OF INTEREST WAS

The pulse survey data is collected by the US Census Bureau...

If covid exacerbated inequalities / disparities in access 

We were interested in further parsing out the relationships between mental health, healthcare access, and race and ethnicity during COVID-19. To do so, we investigated whether or not an unsupervised clustering algorithm could identify racial/ethnic groups from healthcare related variables. Further we arranged racial/ethnic groups in a network where connections between groups are weighted by how similar their population samples responded to questions about mental health symptoms, access to mental health resources, and healthcare coverage.


What are your findings? What kind of statistical computations (if any) have you done to support those conclusions? (Again, even if you display code showing how some of the calculations were performed, it is up to you to interpret, in simple terms, the results of these calculations.) Do not forget about units, axis labels, etc.

## Data Sources 

### Data-sets 

For the clustering and Racial/Ethnic groups network, we used data from the U.S. Census Bureau's Household Pulse Survey. This survey was designed to collect information on how COVID-19 has impacted the social and economic lives of American households; it is motivated by the idea that understanding the pandemic's impacts will help build policy and outreach to help individuals and families recover from the pandemic.

The specific data-sets we used were those from Weeks 22 through 39, which covers 6 January 2021 to 11 October 2021. This timeframe encapsulates the introduction of the vaccine as well as of the Delta Variant in the U.S. We focused on college-aged individuals (18-25) and pulled out the following survey questions:

* "What is your race?" and "Are you of Hispanic, Latino, or Spanish origin?", from which individuals can be classified as 5 different groups: 
  + Hispanic or Latino
  + Non-Hispanic White
  + Non-Hispanic Black
  + Non-Hispanic Asian
  + Non-Hispanic Other/Multiple Races

* "Over the last 2 weeks, how often have you been bothered by feeling nervous, anxious, or on edge?" and, similarly, "Over the last 2 weeks, how often have you been bothered by feeling down, depressed, or hopeless?", for which an individual can respond 
  + Not at all
  + Several days
  + More than half the days
  + Nearly every day

* "At any time in the last 4 weeks, 
  + "did you take prescription medication to help you with any emotions or with your concentration, behavior or mental health?"
  + "did you receive counseling or therapy from a mental health professional such as a psychiatrist, psychologist, psychiatric nurse, or clinical social worker?"
  + "did you need counseling or therapy from a mental health professional, but DID NOT GET IT for any reason?"
  
  For each of these three questions, an individual can respond "Yes" or "No"

* "Are you currently covered by any of the following types of health insurance or health coverage plans?" which includes many types of healthcare. Any respondent who answered "Yes" to one of the healthcare types is labeled as having some healthcare coverage, whereas individuals who responded "No" to all healthcare types is labeled as having no healthcare coverage.

MENTION HOW WE PULLED ONLY CHRONIC DEPRESSION/ANXIETY OR DIDNT DO THAT IDK. OR JUST DO THIS IN THE CODE CHUNK COMMENTS. 

Visit [the Census Bureau website](https://www.census.gov/programs-surveys/household-pulse-survey.html) to explore and download the data-sets. 

### Data Wrangling

Clustering:

For clustering, we were particularly interested in the disparities in access to or use of mental health and healthcare resources between racial/ethnic groups, which may be particularly exacerbated during COVID-19. To group similar indiviuals in this regard, we used kmeans clustering and the `mclust` package. Kmeans clustering requires variables to cluster by (the data the algorithm uses to identify implicit patterns), a chosen number of clusters to identify (`centers = `), and a number of initial random cluster centers to try out (`nstart = `). As we suggested that there may be distinct clusters based on racial/ethnic groups, we set the algorithm to identify five clusters.

```{r echo=TRUE, eval=FALSE}
# Set seed for reproducibility 
set.seed(1984)
# Cluster with healthcare access variables
clustering_vars <- c("prescription", "mental_health_services", "no_access", "healthcare")
# From data set with all variables (columns) and all respondents (rows), select only those for clustering
pulse_all_clusters <- pulse_college_data %>% 
  select(clustering_vars) %>% 
  # Try 5 clusters (there are 5 racial/ethnic groups) and 25 initial centers
  kmeans(centers = 5, nstart = 25)

# Add cluster assignments to data frame
pulse_clustered_data <- pulse_college_data %>% 
  mutate(clusters = factor(pulse_all_clusters$cluster))
```

To check if five clusters was a good number to use, we

We then constructed an elbow plot to assess whether or not five was actually an optimal number of clusters to use. The "elbow" bends where the total within-cluster sum of squares (which measures variation within clusters) begins decreasing linearly. At this point, identifying more clusters becomes less useful. Viewing this plot, it is clear either five or six clusters is optimal. 

```{r echo=TRUE, eval=FALSE}
# Check usefulness of 5 clusters with elbow plot
elbow_plot <- data.frame(clusters = 1:10,
                         within_ss = rep(NA, 10))

set.seed(1984)
for (i in 1:10){
  pulse_out <- pulse_clustered_data %>% 
    select(clustering_vars) %>% 
    kmeans(centers = i, nstart = 25)
  
  elbow_plot$within_ss[i] <- pulse_out$tot.withinss
}

# Construct elbow plot
clusters_elbow <- ggplot(elbow_plot, aes(x = clusters, y = within_ss)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(breaks = 1:10) +
  labs(x = "Number of clusters (k)", y = expression("Total Withins"[k]))
clusters_elbow
```

The clusters can be visualized in three-dimensional plots, looking at three of the four variables at a time. We can switch the three variables with an interactive plot. 

## Creating the interactive network using `visNetwork` in Shiny app {.tabset .tabset-fade .tabset-pills}

### UI

###  Server

ADD THIS

To investigate what patterns the clusters identified, we then looked at the breakdown of racial/ethnic groups and responses to the four mental health and healthcare variables within each cluster. 

PASTE THE PLOT AND GGANIMATE BELOW

INCLUDE CODE FOR GGANIMATE?

## Findings

While the kmeans clustering did not exactly separate out the five racial/ethnic groups, it did demonstrate that access to mental health and healthcare resources is not independent of race and ethnicity. That is the distribution of racial/ethnic groups across clusters and compared to the distribution for all Pulse Survey respondents differs. Most strikingly, cluster 5 has prominently more Hispanic or Latino and Black individuals in it, and fewer white individuals, than the distribution of all respondents. Importantly, cluster 5 is also the cluster where nearly all individuals do not use prescription medication, do not participate in counseling or something similar, have needed mental health resources but have been unable to get to them, and do not have healthcare coverage. 

Further, the clusters which are more predominantly white than the full respondents pool - clusters 1 and 2 - are also those where the most access to care and resources lie, with the main difference being that individuals in cluster 2 do not utilize counseling or similar mental health services, whereas individuals in cluster 1 do. 

### Limitations?

Overall, while clustering is a fun exercise to see what patterns emerge, this was quite limited by the clustering variables, which, though represented numerically, are actually categorical variables. Quantitative and more nuanced variables would provide more meaningful and complex information to identify similar groups with. 

### Data Wrangling

Network:

"Networks need a format where there are nodes and edges  . In order to convert the data into a format for networks, we utilized the following code, using the `visNetwork` and `igraph` packages." (Tracy)

This code chunk demonstrates wrangling for the 

LIMITATION: WE DIDNT GET TO COMPARE BEFORE AND AFTER COVID AND IT MIGHT BE INTERESTED TO SEE HOW DISPARITIES CHANGE DURING THIS TIME. LIKE COULD IT ACTUALLY HAVE GOTTEN BETTER BECAUSE MORE AWARENESS WAS BROUGHT TO IT? 

Network: 

 The code chunk covers wrangling for the `Restaurants.csv` data set, but the exact same procedure was repeated with the other four data sets. Once we had our data into a data frame organized into three columns, where there was a     , as well as the edge weight, we can create an igraph object using the `graph_from_data_frame` function in the `igraph` package. We then used the `toVisNetworkData` function from the `visNetwork` package to transform the igraph into a format readily usable for `visNetwork`. 

```{r echo=TRUE, eval=FALSE}
# Create an igraph object
restaurants_igraph <- graph_from_data_frame(restaurants_final, directed = FALSE)

# Convert igraph to visNetwork format
restaurants_visNetwork <- toVisNetworkData(restaurants_igraph)
```

The `visNetwork` package allows different attributes for customization of nodes and edges. The edges dataset in the visNetwork object originally contains    columns, but we added a column for edge width and edge labels using the `mutate` function from `dplyr`. The nodes dataset in the visNetwork originally contains     , but we also added a new column for color, where color corresponded to the proportion of annual COVID cases per state population. The `eigScalePal` function creates a gradient of colors from the `colorRampPalette` function, and the `mutate` command essentially breaks the values into   .

```{r echo=TRUE, eval=FALSE}
# Set color palette
eigScalePal <- colorRampPalette(c("blue", "red"), bias = 5)
num_colors <- 5

# Wrangle edges data
restaurants_edges <- restaurants_visNetwork$edges %>%
  # Create a new column for edge width
  mutate(value = as.numeric(restaurants_overLap),
         width = value/100) %>%
  select(-value) 

restaurants_edges <- restaurants_edges %>%
  # Create a new column for edge labels that appear when hovered over
  mutate(title = paste0(restaurants_edges$restaurants_overLap, " days shared in 2020"))

# Wrangle nodes data
restaurants_nodes <- restaurants_visNetwork$nodes %>%
  # Join annual cases dataset
  inner_join(annual_cases, by = c("id" = "state")) %>%
  # Create a new column for node color, colored by annual COVID cases in relation to color palette legend
  mutate(color = eigScalePal(num_colors)[cut(covid_prop, breaks = num_colors)]) %>%
  select(-c(covid_prop))
```

## Creating the interactive network using `visNetwork` in Shiny app {.tabset .tabset-fade .tabset-pills}

### UI

```{r echo=TRUE, eval=FALSE}
ui <- fluidPage(title = "State COVID Restrictions Network",
                fillPage(sidebarLayout(
                  sidebarPanel(
                    selectizeInput(
                      inputId = "filterNodes",
                      label = "Select states:",
                      choices = node_values,
                      selected = "AK",
                      multiple = TRUE
                    ),
                    selectInput(
                      inputId = "restriction",
                      label = "Select a type of COVID restriction",
                      choices =  list(
                        "Resturant Restrictions" = "rest",
                        "Bar Restrictions" = "bar",
                        "Mask Mandates" = "mask",
                        "Gathering Bans" = "gatban",
                        "Stay at Home Orders" = "stayhome"),
                      selected = "gatban",
                      multiple = FALSE
                    ),
                    br(),
                    p("Proportion of Annual COVID Cases per State Population"),
                    img(src="covid_legend.png", width = "500px", height = "500px"),
                    width = 3,
                  ),
                  mainPanel(
                    visNetworkOutput("network_proxy_update", width = "100%", height = "90vh"),
                    width = 9
                  )
                )))
```


###  Server

```{r echo=TRUE, eval=FALSE}
############
# server   #
############

server <- function(input, output) {
  
  output$network_proxy_update <- renderVisNetwork({
    visNetwork(active_nodes(), active_edges(), height = "700px", width = "100%", 
               main = list(text = "Network for States Sharing the Same COVID Restrictions in 2020", 
                           style = "font-family:Arial;font-size:20px"
               ),
               submain = list(text = 
                                "*Nodes are colored by proportion of annual COVID cases per state population<br>
                                 *Edges are weighted by number of days in 2020 that states shared 
                                 the same restrictions<br>
                                 Hover over edges to see the exact number of days",
                              style = "font-family:Arial;font-size:13px")) %>%
      visNodes(size = 10) %>%
      visOptions(selectedBy = "group", 
                 highlightNearest = list(enabled = TRUE, hover = TRUE), 
                 nodesIdSelection = TRUE) %>%
      visPhysics(stabilization = FALSE) %>%
      visEdges(color = list(color = "black", highlight = "red")) 
  })
  
  myVisNetworkProxy <- visNetworkProxy("network_proxy_update")
  
  observe ({
    # Create an object to contain the nodes the user selects
    filteredNodes <- active_nodes()[gathering_ban_nodes$id %in% input$filterNodes, ,drop = FALSE]
    # Create an object to create all the nodes the user did not select
    hiddenNodes <- anti_join(active_nodes(), filteredNodes)
    # 
    visRemoveNodes(myVisNetworkProxy, id = hiddenNodes$id)
    visUpdateNodes(myVisNetworkProxy, nodes = filteredNodes)
  })
}

#####################
# call to shiny App #
#####################
shinyApp(ui = ui, server = server)
```

## Findings 

### Helen



Overall, the network allows users to explore the relationships between different states of their choice in terms of how many days in 2020 they shared the same COVID restrictions, as well as specify which restriction they wanted to look at. There are many different analyses that can come about, but it's interesting to see that there is not one dominant pattern or takeaway, and that states with radically different annual COVID cases per population could share the same restrictions, whereas       . This underlies the complexity, and state restrictions are only one factor within many that influence the proportion of COVID cases that emerge.

# Limitations 
What are the limitations of your work? Be clear so that others do not misinterpret your findings. To what population do your results apply? Do they generalize? Could your work be extended with more data or computational power or time to analyze? How could your study be improved? Suggesting plausible extensions doesn’t weaken your work; it strengthens it by connecting it to future work. 

For example, you can include **Bold** and _Italic_ and `Code` text.  

You should test out updating your GitHub Pages website:

* clone your group's blog project repo in RStudio
* update "Your Project Title Here" to a new title in the YAML header
* knit `index.Rmd` (we will now knit to HTML by default instead of pdf)
* commit and push **both** `index.Rmd` and `index.html`
* go to https://stat231-f21.github.io/blog_THeHe/ to see the published test document (this is publicly available!)

## Including code and plots

You can embed code as normal, for example:

```{r cars}
summary(cars)
```

Let's clean up the format of that output instead of using the standard R output:

```{r pretty-table, echo = TRUE}
summary(cars) %>%
  kable(col.names = c("Speed", "Distance"),
        row.names = FALSE) %>%
  kable_styling(bootstrap_options = "striped",
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE) %>%
  column_spec(1:2, width = "1.5in") 
```

In a study from the 1920s, fifty cars were used to see how the speed of the car and the distance taken to stop were related.  Speeds ranged between `r min(cars$speed)` and `r max(cars$speed)` mph.  Distances taken to stop ranged between `r min(cars$dist)` and `r max(cars$dist)` feet, with the middle 50% falling between `r as.numeric(quantile(cars$dist)[2])` and `r as.numeric(quantile(cars$dist)[4])` feet.  

You can also embed plots as normal, for example:

```{r figure1}
ggplot(data = cars, aes(x = speed, y = dist)) + 
  geom_point() + 
  labs(x = "Speed of car (mph)",
       y = "Distance taken to stop (ft)",
       title = "Stopping distance increases with faster speeds",
       subtitle = "Based on 1920s study") +
  theme_classic()
```

Take note of the default code chunk options in the `setup` code chunk, and adjust individual code chunk options as needed. for example, unlike the rest of the Rmd files we worked in this semester, the default code chunk option is `echo = FALSE`, so you will need to set `echo  = TRUE` for any code chunks you would like to display in the blog. 


## Including links and images/videos

You can include [links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and there are a few ways to embed  images! Both options for embedding images below can be used interchangeably. They both work for png, pdf, jpg, and even gif formats, and both support filepaths that are either URLs (for videos, you can include links to any valid YouTube or Vimeo URLs; see [here](https://bookdown.org/yihui/rmarkdown/learnr-videos.html) for more details) or point to a location within your project directory. 

### Option 1: Markdown approach

<!-- ![This is a figure caption. The artwork is called Safe Space by  [Kenesha Sneed](https://www.keneshasneed.com/#/safespace/)](img/Kenesha-Sneed_safe-space.jpeg) -->


### Option 2: Code chunk approach

```{r, fig.cap = "This is also figure caption"}
knitr::include_graphics("https://media.giphy.com/media/H7ZrrA9V2pd3Tehdds/giphy.gif")
```

# You can even create tabs within your webpage if you want! {.tabset .tabset-fade .tabset-pills}

Every subsection heading (starting with `##`) until you create a new section heading (starting with `#`) will be a new tab.

## Bulleted list

You can make a bulleted list like this:

* item 1
* item 2
* item 3


## Numbered list

You can make a numbered list like this

1. First thing I want to say
2. Second thing I want to say
3. Third thing I want to say

# Customizing your blog design

As a *final* detail **only** if you have time, you can explore options for customizing the style of your blog. By default, we are using the `readthedown` theme from the [**rmdformats** package](https://github.com/juba/rmdformats) (see Line 6 of this file if you want to switch out themes). There are, I'm sure, many many many more similar packages with built in themes, or you can look into how to include a CSS code chunk to customize aspects of the current theme.  

There are some easy-to-change options that you can play around with:

* The theme itself (Line 6): `rmdformats::readthedown`, `rmdformats::downcute`, `rmdformats::robobook`, `rmdformats::material`,
  * For `downcute` only, you can add a new indented line below Line 6 with the code `downcute_theme: "chaos"` for the `downcute chaos` theme
  * I would *not* recommend the other themes that do not have the sidebar navigation
  
* Syntax highlighting options (Line 8, `highlight`): `"default"`, `"tango"`, `"pygments"`, `"kate"`, `"monochrome"`, `"espresso"`, `"zenburn"`, `"haddock"`, or `"textmate"` (or `NULL` for no syntax highlighting)


You can explore additional customizable YAML options by looking at the [**rmdformats** package](https://github.com/juba/rmdformats) page or running, for example, `?rmdformats::readthedown()` to see the help documentation for a particular theme from the package.
